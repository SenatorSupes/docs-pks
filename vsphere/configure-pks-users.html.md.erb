---
title: Set up Enterprise PKS Users
owner: PKS
iaas: vsphere
---

This topic describes how to manage users in <%= vars.product_full %> with User Account and Authentication (UAA).
Create and manage users in UAA with the UAA Command Line Interface (UAAC).

## <a id='overview'></a> Overview

Use the UAA Command Line Interface (UAAC) to interact with the UAA server.
You can either run UAAC commands from the Ops Manager VM or install UAAC on your local workstation.


## <a id='prerequisites'></a> Prerequisites

Before setting up admin users for <%= vars.product_short %>, you must have one of the following:

* SSH access to the Ops Manager VM, or

* A machine that can connect to your PKS control plane VM

## <a id='connect'></a> Connect to the PKS Control Plane VM

You can connect to the PKS control plane VM from the Ops Manager VM or from a different machine such as your local workstation.

### <a name='ssh-vsphere'></a> Connect through the Ops Manager VM

You can connect to PKS control plane VM by logging in to the Ops Manager VM through SSH.
To SSH into the Ops Manager VM on vSphere, do the following:

1. Retrieve the credentials you used to import the PCF .ova or .ovf file into vSphere.
You set these credentials in the [Prepare vSphere](https://docs.pivotal.io/pivotalcf/2-5/om/vsphere/deploy.html#deploy) section of _Deploying Ops Manager on vSphere_.

  <p class="note"><strong>Note</strong>: If you lose your credentials, you must shut down the Ops Manager VM in the vSphere UI and reset the password. See <a href="https://docs.vmware.com/en/VMware-vSphere/6.5/com.vmware.vsphere.security.doc/GUID-4BDBF79A-6C16-43B0-B0B1-637BF5516112.html">vCenter Password Requirements and Lockout Behavior</a> in the vSphere documentation for more information.</p>

1. From a command line, run the following command to SSH into the Ops Manager VM:

    ```
    ssh ubuntu@OPS-MANAGER-FQDN
    ```
    Where `OPS-MANAGER-FQDN` is the fully qualified domain name (FQDN) of Ops Manager.
    
    For example:

    <pre class="terminal">
    $ ssh ubuntu&#64;my-opsmanager-fqdn.example.com
    Password: ***********
    </pre>

1. Proceed to the [Log in as an Admin](#uaa-admin-login) section to create admin users with UAAC.

### <a name='local-workstation'></a> Connect through Other Machines

To connect to the PKS control plane VM and run UAA commands, do the following:

1. Install the UAA Command Line Interface (UAAC) on your machine. For example:
  
  ```
  gem install cf-uaac
  ```
1. Download a copy of your Ops Manager root CA certificate to the machine. To download the certificate, do the following:

  1. In Ops Manager, navigate to **Settings** under your username.
  1. Click **Advanced Options**.
  1. On the **Advanced Options** configuration page, click **Download Root CA Cert**.
  1. Move the certificate to a secure location on your machine and record the path.
  1. Proceed to the [Log in as an Admin](#uaa-admin-login) section to create admin users with UAAC.

##<a id='uaa-admin-login'></a> Log in as a UAA Admin

To create PKS admin users, log in to the UAA server on the PKS control plane as a UAA admin by following the steps below:

1. Retrieve the UAA management admin client secret:

  1. In a web browser, navigate to the FQDN of Ops Manager and click the **<%= vars.product_tile %>** tile.

  1. Click **Credentials**.

  1. To record the secret, click **Link to Credential** next to **Pks Uaa Management Admin Client** and copy the value of `secret`.

1. Target your UAA server by running the following command:

    ```
    uaac target https://PKS-API:8443 --ca-cert CERT-PATH
    ```

    Where:
    * `PKS-API` is the URL of your PKS API server. You configured this URL in the PKS API section of _Installing <%= vars.product_short %>_ for your IaaS. For example, see [Installing <%= vars.product_short %> on vSphere](installing-pks-vsphere.html#pks-api).
    * `CERT-PATH` is the path to your root CA certificate. Provide the certificate to validate the PKS API certificate with SSL.
      * If you are logged in to the Ops Manager VM, specify `/var/tempest/workspaces/default/root_ca_certificate` as the path. This is the default location of the root certificate on the Ops Manager VM.
      * If you downloaded the Ops Manager root CA certificate to your machine, specify the path where you stored the certificate. 
    For example:
    <pre class="terminal">
    $ uaac target api.pks.example.com:8443 --ca-cert /var/tempest/workspaces/default/root_ca_certificate
    </pre>
    <p class="note"><strong>Note</strong>: If you receive an <code>Unknown key: Max-Age = 86400</code> warning message, you can safely ignore it because it has no impact.</p>

1. Authenticate with UAA using the secret you retrieved in a previous
step by running the following command:

    ```
    uaac token client get admin -s ADMIN-CLIENT-SECRET
    ```
    Where `ADMIN-CLIENT-SECRET` is your UAA management admin client secret. The client username is `admin`.


##<a id='pks-access'></a> Grant <%= vars.product_short %> Access

<%= vars.product_short %> access gives users the ability to deploy and manage Kubernetes clusters.
As an Admin user, you can assign the following UAA scopes to users, external LDAP groups, and clients:

  * `pks.clusters.manage`: Accounts with this scope can create and access their own clusters.
  * `pks.clusters.admin`: Accounts with this scope can create and access all clusters.

###<a id='uaa-user'></a> Grant <%= vars.product_short %> Access to a User

To create a new UAA user with <%= vars.product_short %> access, do the following:

1. If you are not logged in as the UAA admin, follow the steps in [Log in as a UAA Admin](#uaa-admin-login).

1. To create a new user, run the following command:

    ```
    uaac user add USERNAME --emails USER-EMAIL -p USER-PASSWORD
    ```

    For example:
    <pre class="terminal">$ uaac user add cody --emails cody&#64;example.com -p password</pre>

1. To assign a scope to the new user, run the following command:

    ```
    uaac member add UAA-SCOPE USERNAME
    ```
    Where `UAA-SCOPE` is one of the UAA scopes defined in [Grant <%= vars.product_short %> Access](#pks-access). For
    example:
    <pre class="terminal">$ uaac member add pks.clusters.admin cody</pre>

After you assign this scope, the user can create and manage Kubernetes clusters. For more information, see [Managing Clusters](managing-clusters.html).

###<a id='external-group'></a> Grant <%= vars.product_short %> Access to an External LDAP Group

Connecting <%= vars.product_short %> to an LDAP external user store allows the User Account and Authentication (UAA) server to delegate authentication to existing enterprise user stores.

<p class='note'><strong>Note</strong>: When integrating with an external identity provider such as
LDAP, authentication within the UAA becomes chained. UAA first attempts to authenticate with a
user's credentials against the UAA user store before the external provider, LDAP. For more
information, see <a href="https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-LDAP.md#chained-authentication">Chained Authentication</a> in the <em>User Account and Authentication LDAP Integration</em> GitHub documentation.
</p>

For more information about the process used by the UAA Server when it attempts to authenticate a
user through LDAP, see the [Configuring LDAP Integration with Pivotal Cloud Foundry](https://community.pivotal.io/s/article/Configuring-LDAP-Integration-with-Pivotal-Cloud-Foundry) Knowledge Base article.

To grant <%= vars.product_short %> access to an external LDAP group, perform the following steps:

1. Log in as the UAA admin using the procedure in [Log in as a UAA Admin](#uaa-admin-login).

1. To assign the `pks.clusters.manage` scope to all users in an LDAP group, run the following command:

    ```
    uaac group map --name pks.clusters.manage GROUP-DISTINGUISHED-NAME
    ```
    Where `GROUP-DISTINGUISHED-NAME` is the LDAP Distinguished Name (DN) for the group. For example:
    <pre class="terminal">
    $ uaac group map --name pks.clusters.manage cn=operators,ou=groups,dc=example,dc=com
    </pre>
    For more information about LDAP DNs, see the [LDAP DNs and RDNs](https://ldap.com/ldap-dns-and-rdns/) in the LDAP documentation.

1. (Optional) To assign the `pks.clusters.admin` scope to all users in an LDAP group, run the following command:

    ```
    uaac group map --name pks.clusters.admin GROUP-DISTINGUISHED-NAME
    ```
    Where `GROUP-DISTINGUISHED-NAME` is the LDAP DN for the group. For example:
    <pre class="terminal">
    $ uaac group map --name pks.clusters.admin cn=operators,ou=groups,dc=example,dc=com
    </pre>

###<a id='uaa-client'></a> Grant <%= vars.product_short %> Access to a Client

To grant <%= vars.product_short %> access to an automated client for a script or service, perform the following steps:

1. Log in as the UAA admin using the procedure [Log in as a UAA Admin](#uaa-admin-login).

1. Run the following command to create a client with the desired scopes:

    ```
    uaac client add CLIENT-NAME -s CLIENT-SECRET \
    --authorized_grant_types client_credentials \
    --authorities UAA-SCOPES
    ```
    Where:
    * `CLIENT-NAME` and `CLIENT-SECRET` are the client credentials.
    * `UAA-SCOPES` is one or more of the UAA scopes defined in [Grant <%= vars.product_short %> Access](#pks-access), separated by a comma. For example:
    <pre class="terminal">
    $ uaac client add automated-client \
    -s randomly-generated-secret
    --authorized_grant_types client_credentials  \
    --authorities pks.clusters.admin,pks.clusters.manage
    </pre>
